{
	"name": "DF_ODS1_BEG_FACT_PROCEDENCIA1",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "STG_BEG_FACT_TOTAL_EXEMPLARS_PROCEDENCIA",
						"type": "DatasetReference"
					},
					"name": "STGFactProcedencia"
				},
				{
					"dataset": {
						"referenceName": "DM_BEG_DIM_BIBLIOTEQUES",
						"type": "DatasetReference"
					},
					"name": "DimBiblioteques"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "ODS1_BEG_FACT_TOTAL_EXEMPLARS_PROCEDENCIA",
						"type": "DatasetReference"
					},
					"name": "ODS1Procedencia"
				}
			],
			"transformations": [
				{
					"name": "Join"
				},
				{
					"name": "CrearIndicadores"
				},
				{
					"name": "EliminarColumnas"
				},
				{
					"name": "Unpivot"
				},
				{
					"name": "Datas"
				},
				{
					"name": "NullCero"
				}
			],
			"scriptLines": [
				"parameters{",
				"     Data_Carrega as string",
				"}",
				"source(output(",
				"          Codi as string,",
				"          Significat as string,",
				"          {0} as string,",
				"          {-1} as string,",
				"          {-2} as string,",
				"          {-3} as string,",
				"          {-4} as string,",
				"          {-5} as string,",
				"          {-6} as string,",
				"          {-7} as string,",
				"          {-8} as string,",
				"          {-9} as string,",
				"          {-10} as string,",
				"          {-11} as string,",
				"          {-12} as string,",
				"          {-13} as string,",
				"          {-14} as string,",
				"          {-15} as string,",
				"          {-16} as string,",
				"          {-17} as string,",
				"          {-18} as string,",
				"          {-19} as string,",
				"          {-20} as string,",
				"          {-21} as string,",
				"          {-22} as string,",
				"          {-23} as string,",
				"          {  Totals  } as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     format: 'table') ~> STGFactProcedencia",
				"source(output(",
				"          ID_BIBLIOTECA as integer,",
				"          ID_AGENCY as string,",
				"          ID_USUARI as integer,",
				"          CODI_BIBLIOTECA as string,",
				"          ID_TIPUS as integer,",
				"          ID_MODUL as integer,",
				"          CODI_NIDEN as string,",
				"          ID_ESTAT as integer,",
				"          DESC_BIBLIOTECA as string,",
				"          DATA_ALTA_BIBLIO as timestamp,",
				"          DATA_BAIXA_BIBLIO as timestamp,",
				"          ID_TIPUS_VIA as integer,",
				"          DESC_VIA as string,",
				"          NUM_VIA as string,",
				"          INE_MUNICIPI as string,",
				"          ID_DISTRICTE as integer,",
				"          CP as string,",
				"          UTMX as double,",
				"          UTMY as double,",
				"          NUM_LONGITUD as double,",
				"          NUM_LATITUD as double,",
				"          NUM_TELEFON as string,",
				"          NUM_EXTENSIO as string,",
				"          NUM_FAX as string,",
				"          DESC_EMAIL as string,",
				"          DESC_WEB as string,",
				"          FLAG_BEG as boolean,",
				"          FLAG_SLPC as boolean,",
				"          ID_MAPA as integer,",
				"          ID_CATEGORIA as integer,",
				"          ID_TITULARITAT as integer,",
				"          ID_FORMA_ACCES as integer,",
				"          ES_CATALEG_COLECTIU_CCLP as boolean,",
				"          WEB_CATALEG_COLECTIU_CCLP as string,",
				"          ES_CATALEG_COLECTIU_DIP_BCN as boolean,",
				"          WEB_CATALEG_COLECTIU_DIP_BCN as string,",
				"          ES_CATALEG_COLECTIU_CCUC as boolean,",
				"          WEB_CATALEG_COLECTIU_CCUC as string,",
				"          ES_CATALEG_COLECTIU_BEG as boolean,",
				"          WEB_CATALEG_COLECTIU_BEG as string,",
				"          ES_CATALEG_COLECTIU_ALTRES as boolean,",
				"          WEB_CATALEG_COLECTIU_ALTRES as string,",
				"          ID_DIRECTOR_TRACTAMENT as integer,",
				"          DESC_DIRECTOR_NOMB as string,",
				"          DESC_DIRECTOR_PRIMER_COGNOM as string,",
				"          DESC_DIRECTOR_SEGON_COGNOM as string,",
				"          FLAG_ADAPTADA as boolean,",
				"          DESC_OBSERVACIONS as string,",
				"          OBS_ITINERARIS as string,",
				"          DATA_ALTA as timestamp,",
				"          ID_USUARI_ALTA as integer,",
				"          DATA_MODIF as timestamp,",
				"          ID_USUARI_MODIF as integer,",
				"          DATA_BAIXA as timestamp,",
				"          ID_USUARI_BAIXA as integer,",
				"          ID_ADSCRIPCIO as integer,",
				"          ID_CATEGORIA_ESP as integer",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     format: 'table') ~> DimBiblioteques",
				"STGFactProcedencia, DimBiblioteques join(Codi == ID_AGENCY,",
				"     joinType:'right',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> Join",
				"Join derive(IND_18_2 = toInteger(replace(trim({-1}),'.','')),",
				"          IND_18_3 = toInteger(replace(trim({-3}),'.','')),",
				"          IND_18_4 = toInteger(replace(trim({-4}),'.','')),",
				"          IND_18_5 = toInteger(replace(trim({-6}),'.','')),",
				"          IND_18_6 = toInteger(replace(trim({-8}),'.','')),",
				"          IND_18_7 = toInteger(replace(trim({-13}),'.','')),",
				"          IND_18_011 = toInteger(replace(trim({-2}),'.',''))+toInteger(replace(trim({-5}),'.',''))+toInteger(replace(trim({-7}),'.',''))+toInteger(replace(trim({-9}),'.',''))+toInteger(replace(trim({-10}),'.',''))+toInteger(replace(trim({-11}),'.',''))+toInteger(replace(trim({-12}),'.',''))+toInteger(replace(trim({-14}),'.',''))+toInteger(replace(trim({-15}),'.',''))+toInteger(replace(trim({-16}),'.',''))+toInteger(replace(trim({-17}),'.',''))+toInteger(replace(trim({-18}),'.',''))+toInteger(replace(trim({-22}),'.',''))+toInteger(replace(trim({-23}),'.',''))) ~> CrearIndicadores",
				"CrearIndicadores select(mapColumn(",
				"          CODI_BIBLIOTECA,",
				"          IND_18_2,",
				"          IND_18_3,",
				"          IND_18_4,",
				"          IND_18_5,",
				"          IND_18_6,",
				"          IND_18_7,",
				"          IND_18_011",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> EliminarColumnas",
				"EliminarColumnas unpivot(output(",
				"          CODI_INDICADOR as string,",
				"          IND_VALOR as integer",
				"     ),",
				"     ungroupBy(CODI_BIBLIOTECA),",
				"     lateral: true,",
				"     ignoreNullPivots: false) ~> Unpivot",
				"NullCero derive(DATA_INSERCIO = currentDate(),",
				"          DATA_PERIODE = toDate(concat($Data_Carrega,'01'),'yyyyMMdd')) ~> Datas",
				"Unpivot derive(IND_VALOR = iifNull(IND_VALOR, 0)) ~> NullCero",
				"Datas sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     input(",
				"          CODI_BIBLIOTECA as string,",
				"          CODI_INDICADOR as string,",
				"          IND_VALOR as integer,",
				"          DATA_INSERCIO as date,",
				"          DATA_PERIODE as date",
				"     ),",
				"     deletable:false,",
				"     insertable:true,",
				"     updateable:false,",
				"     upsertable:false,",
				"     truncate:true,",
				"     format: 'table',",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     errorHandlingOption: 'stopOnFirstError') ~> ODS1Procedencia"
			]
		}
	}
}